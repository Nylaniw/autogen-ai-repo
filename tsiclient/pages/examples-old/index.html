
<!DOCTYPE html> 
<html><head>
    <title>Time Series Insights JavaScript SDK Examples</title>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache" />
    <script src="https://secure.aadcdn.microsoftonline-p.com/lib/1.0.17/js/adal.min.js"></script>
    
    <!--bluebird for Promise polyfill to support IE in sample client-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>    
    
    <!-- PROD RESOURCE LINKS -->
    <!-- <link rel="stylesheet" type="text/css" href="sampleStyles.css"></link>
    <script src="https://unpkg.com/tsiclient@1.2.24/tsiclient.js"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/tsiclient@1.2.24/tsiclient.css"></link> -->

    <!-- DEV RESOURCE LINKS -->
    <link rel="stylesheet" type="text/css" href="sampleStyles.css" />
    <script src="../../dist/tsiclient.js"></script>
    <link rel="stylesheet" type="text/css" href="../../dist/tsiclient.css" />
</head>
<body>
    <div id="loginModal" style="display: none">
        <div>
            <span id="api_response"></span>
            <a href="#" onclick="authContext.login(); return false;">Log in</a>
        </div>
    </div>
    <div style="height: 100%; position: absolute; top: 0; width: 100%;">
        <div class="header">
            TSI JavaScript SDK Examples
            <pre id="api_response2"></pre>
            <div class="rightSide">
                <div id="username"></div>
                <div class="loginLogout">
                    <p>
                        <a href="#" onclick="authContext.logOut(); return false;">Log out</a>
                    </p>
                </div>
            </div>
        </div><div class="chartsWrapper">
            <div id="selectTitleWrapper">
                <select value="1" id="selectTitle" class="dark" onchange="showExample(this)">
                    <option value="1">1. Static Line Charts</option>
                    <option value="2">2: Multiple Chart Types From the Same Data</option>
                    <option value="3">3. Charts Gracefully Animating Data In and Out, While Changing Theme</option>
                    <option value="4">4. Line Chart Updating in Real Time</option>
                    <option value="5">5. Line Charts With Multiple Series Types</option>
                    <option value="6">6. Hierarchy Control Coupled With Line Chart</option>
                    <option value="7">7. Line Chart With a Context Menu Which Generates Pie and Bar Chart</option>
                    <option value="8">8. A Standalone Accessible Grid</option>
                    <option value="9">9. Heatmap</option>
                    <option value="10">10. A Table of Events</option>
                    <option value="11">11. An Availability Chart</option>
                    <option value="12">12. Line Chart With Min/Max Envelope and Step Interpolation</option>
                    <option value="13">13. Line Chart From PAYG SKU Environment</option>
                    <option value="14">14. Model Search Component With Hierarchy</option>
                    <option value="15">15. A Standalone Model Autocomplete Component</option>
                    <option value="16">16. A Table of Events from a PAYG SKU</option>
                </select>
            </div>
            <div id="charts">
            </div>
        </div>
    </div>        
    <script type="text/javascript">

          // START: AUTHENTICATION RELATED CODE USING ADAL.JS
            // Set up ADAL
            var authContext = new AuthenticationContext({
                // clientId: '11a652b9-f29f-40c8-ab29-5ccbe2271823',	
                // postLogoutRedirectUri: 'https://tsiclientsample.azurewebsites.net',
                clientId: '120d688d-1518-4cf7-bd38-182f158850b6',
                postLogoutRedirectUri: 'https://insights.timeseries.azure.com',
                cacheLocation: 'localStorage'
            });
            
            if (authContext.isCallback(window.location.hash)) {
            
                // Handle redirect after token requests
                authContext.handleWindowCallback();
                var err = authContext.getLoginError();
                if (err) {
                    // TODO: Handle errors signing in and getting tokens
                    document.getElementById('api_response').textContent = err;
                    document.getElementById('loginModal').style.display = "block";
                }
            
            } else {
                var user = authContext.getCachedUser();
                if (user) {
                    document.getElementById('username').textContent = user.userName;
                    
                } else {
                    document.getElementById('username').textContent = 'Not signed in.';
                }
            }
            
            authContext.getTsiToken = function(){
                document.getElementById('api_response2').textContent = 'Getting tsi token...';
                
                // Get an access token to the Microsoft TSI API
                var promise = new Promise(function(resolve,reject){
                    authContext.acquireToken(
                    'https://api.timeseries.azure.com/',
                    function (error, token) {
            
                        if (error || !token) {
                            // TODO: Handle error obtaining access token
                            document.getElementById('api_response').textContent = error;
                            document.getElementById('loginModal').style.display = "block";
                            document.getElementById('api_response2').textContent = '';
                            return;
                        }
            
                        // Use the access token
                        document.getElementById('api_response').textContent = '';
                        document.getElementById('api_response2').textContent = '';
                        document.getElementById('loginModal').style.display = "none";
                        resolve(token);
                        }
                    );
                });
                
                return promise;
            }

        // Code to show an example, called by the dropdown on change
        var showExample = function(select){
            clearInterval(currentSetInterval);
            var exampleNumber = select.value;
            window['example' + exampleNumber]();
            window.location.hash = exampleNumber;
        }

        // Code to render wrappers to draw charts in
        var renderChartContainers = function(containerNumber, isDarkThemeArray){
            isDarkThemeArray = isDarkThemeArray ? isDarkThemeArray : [];
            document.getElementById('charts').innerHTML = ''; // blow away current content;
            for(var i = 1; i <= containerNumber; i++){
                let cardClass = "card " + (isDarkThemeArray[i - 1] ? 'dark' : '')
                let width = (containerNumber == 1 ? '95%' : (containerNumber == 2 ? '45%' : '30%'))
                document.getElementById('charts').innerHTML += '<div style="width: ' + width + '" class="' + cardClass + '"><div class="cardTitle">' + 'Chart ' + i + '</div><div class="cardChart" id="chart' + i + '"></div></div>';
            }
        }

        // Relevant globals
        var tsiClient = new TsiClient();
        var currentSetInterval;

        // 1. Static Line Charts
        var example1 = function(){
            renderChartContainers(2, [true, false]);
            
            var aggregateExpressions = [];
            var startDate = new Date('2017-04-14T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            let optionsObject1 = {color: '#FF8C00', alias: 'Factory1Pressure', yExtent: [0, 5000]};
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1'"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, optionsObject1));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2'"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, '#D869CB', 'Factory2Pressure'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, '#60B9AE', 'Factory 3 Pressure'));
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {theme: 'dark', grid: true, tooltip: true, legend: 'compact', includeDots: true, interpolationFunction: 'curveLinear'}, aggregateExpressions);
                });
            });
                    
            var aggregateExpressions2 = [];
            aggregateExpressions2.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3' and Temperature > 31"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, '#F7727E', 'Factory3Temperature'));

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions2.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions2);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart2'));
                    lineChart.render(transformedResult, {theme: 'light', grid: true, includeDots: true}, aggregateExpressions2);
                });
            });
        }

        // 2: Multiple Chart Types From the Same Data
        var example2 = function() {
            renderChartContainers(3, [false, true, false]);

            var aggregateExpressions = [];
            var startDate = new Date('2017-04-19T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, '#60B9AE', 'Factory3Temperature'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1'"}, {property: 'Temperature', type: "Double"}, ['min', 'avg', 'max'],
                { from: startDate, to: endDate, bucketSize: '3m' }, {property: 'Station', type: 'String'}, '#D869CB', 'Factory1Temp'));
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {grid: true, legend: 'compact', theme: 'light'}, aggregateExpressions);
                    
                    var barChart =  new tsiClient.ux.BarChart(document.getElementById('chart2'));
                    barChart.render(transformedResult, {grid: true, timestamp: '2017-04-19T13:00:00Z', legend: 'compact'}, aggregateExpressions);

                    var pieChart =  new tsiClient.ux.PieChart(document.getElementById('chart3'));
                    pieChart.render(transformedResult, {grid: true, theme: 'light', timestamp: '2017-04-19T13:00:00Z', arcWidthRatio: .4, legend: 'compact'}, aggregateExpressions);
                });
            });    
        }

        // 3. Charts Gracefully Animating Data In and Out, While Changing Theme
        var example3 = function() {
            renderChartContainers(3, [false, true, false]);

            var aggregateExpressions = [];
            var startDate = new Date('2017-04-19T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            var firstAe = new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                 { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, {color: '#F7727E', alias: 'Factory3Temperature', visibilityState: [true, ['Station2', 'Station4']]});
            aggregateExpressions.push(firstAe);
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);

                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {legend: "compact", tooltip: true}, aggregateExpressions);
                    
                    var barChart = new tsiClient.ux.BarChart(document.getElementById('chart2'));
                    barChart.render(transformedResult, {legend: "compact", zeroYAxis: false, tooltip: true}, aggregateExpressions);

                    var pieChart = new tsiClient.ux.PieChart(document.getElementById('chart3'));
                    pieChart.render(transformedResult, {legend: "compact", zeroYAxis: false, tooltip: true}, aggregateExpressions);

                    var counter = 0;
                    currentSetInterval = setInterval(function () {
                        if(counter < 50){ // so this doesnt just DDOS the backend if the tab is left open
                            if (aggregateExpressions.length == 2) {
                                aggregateExpressions.pop();
                            } else{
                                var secondAe = new tsiClient.ux.AggregateExpression({predicateString: ""}, {property: 'Temperature', type: "Double"}, ['min', 'avg', 'max'],
                                    { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, {color: '#C8E139', alias: 'Factory1Temp'});
                                aggregateExpressions.push(secondAe);
                            }
                            var options = (aggregateExpressions.length == 2) ? {legend: "compact", zeroYAxis: false, theme: 'light', includeDots: true} : {legend: "compact", tooltip: true, grid: true, zeroYAxis: false, theme: 'dark', includeDots: false};

                            tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                                var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                                setTimeout(function(){barChart.render(transformedResult, options, aggregateExpressions)}, 6600);
                                lineChart.render(transformedResult, options, aggregateExpressions);
                                setTimeout(function(){pieChart.render(transformedResult, options, aggregateExpressions)}, 3300);
                            });
                            counter++;
                        }
                    }, 10000);
                });
            });
        }

        // 4. Line Chart Updating in Real Time
        var example4 = function() {
            renderChartContainers(1, [true]);
            var aggregateExpressions = [];
            var startDate = new Date('2017-04-12T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '10s' }, null, '#FF8C00', 'Factory1Temperature'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '10s' }, null, '#D869CB', 'Factory2Temperature'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '10s' }, null, '#60B9AE', 'Factory3Temperature'));
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {includeDots: true}, aggregateExpressions);
                    var counter = 0;
                    setInterval(function () {
                        if(counter < 50){  // so this doesnt just DDOS the backend if the tab is left open
                            startDate = new Date(startDate.valueOf() + 1*1000*6);
                            endDate = new Date(endDate.valueOf() + 1*1000*10);
                            aggregateExpressions.forEach(function(ae){ae.searchSpan.from = startDate; ae.searchSpan.to = endDate});
                            tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                                var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                                lineChart.render(transformedResult, {noAnimate: true, includeDots: true}, aggregateExpressions);
                            });
                            counter++;
                        }
                    }, 2000);                    
                });
            });    
        }

        // 5. Line Charts with Multiple Series Types
        var example5 = function() {
            renderChartContainers(1, [true]);

            var startDate = new Date('2017-04-19T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);

            var states = {"Component States" : [
                {
                    '2017-04-19T13:05:00Z' : {
                        'color': 'lightblue',
                        'description' : 'Cooling fan on'
                    }
                },
                {
                    '2017-04-19T13:27:00Z' : {
                        'color': '#C8E139',
                        'description' : 'Filling tank at maximum pressure'
                    }
                },
                {
                    '2017-04-19T13:47:00Z' : {
                        'color': '#D869CB',
                        'description' : 'Pressing machine overheated'
                    }
                }
            ]};

            var events = {"Incidents" : [
                {
                    '2017-04-19T13:12:00Z' : {
                        'color': '#C8E139',
                        'description' : 'Recoverable failure'
                    }
                },
                {
                    '2017-04-19T13:25:00Z' : {
                        'color': '#D869CB',
                        'description' : 'Catastrophic failure'
                    }
                },
                    {
                    '2017-04-19T13:47:00Z' : {
                        'color': '#D869CB',
                        'description' : 'Informational event'
                    }
                }
            ]};

            var aggregateExpressions = [];
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, '#60B9AE', 'Factory3Temperature'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1'"}, {property: 'Temperature', type: "Double"}, ['min', 'avg', 'max'],
                { from: startDate, to: endDate, bucketSize: '3m' }, {property: 'Station', type: 'String'}, '#D869CB', 'Factory1Temp'));

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {tooltip: true, grid: true, theme: "dark", events: [events], states: [states]}, aggregateExpressions);
                });
            }); 
        }

        // 6. Hierarchy Control Coupled With Line Chart
        var example6 = function() {
            renderChartContainers(2, [true, true]);

            var startDate = new Date('2017-04-19T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            var hierarchyAggregateExpressions = [];
            var hierarchyEvents = [];
            var hierarchyStates = [];
            var hierarchy = {
                'Factory1': {
                    'Station1': {
                        'GC4F-286 (Temp)': {$leaf: true, click: function(n){
                            if(!n._ae)
                                n._ae = new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1' AND Station = 'Station1'"}, {property: 'Temperature', type: "Double"}, ['avg'],
                                { from: startDate, to: endDate, bucketSize: '10s' }, null, '#D869CB', 'F1S1Temp');
                            renderHierarchyLineChart(n);
                        }},
                        'F92-21B (Pressure)': {$leaf: true, click: function(n){
                            if(!n._ae)
                                n._ae = new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1' AND Station = 'Station1'"}, {property: 'Pressure', type: "Double"}, ['avg'],
                                { from: startDate, to: endDate, bucketSize: '1m' }, null, '#60B9AE', 'F1S1Pressure');
                            renderHierarchyLineChart(n);
                        }}                    
                    }
                },
                'Factory2': {
                    'Station1': {
                        '19C2-F8 (Temp)': {$leaf: true, click: function(n){
                            if(!n._ae)
                                n._ae = new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2' AND Station = 'Station1'"}, {property: 'Temperature', type: "Double"}, ['avg'],
                                { from: startDate, to: endDate, bucketSize: '10s' }, null, '#C8E139', 'F2S1Temp');
                            renderHierarchyLineChart(n);
                        }},
                        'B9-C86 (Pressure)': {$leaf: true, click: function(n){
                            if(!n._ae)
                                n._ae = new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2' AND Station = 'Station1'"}, {property: 'Pressure', type: "Double"}, ['avg'],
                                { from: startDate, to: endDate, bucketSize: '1m' }, null, '#FF8C00', 'F2S1Pressure');
                            renderHierarchyLineChart(n);
                        }}                    
                    }
                }
            }
            
            var hierarchyCtrl = new tsiClient.ux.Hierarchy(document.getElementById('chart1'));
            hierarchyCtrl.render(hierarchy, {});
            
            var lineChartForHierarchy = new tsiClient.ux.LineChart(document.getElementById('chart2'));
            var renderHierarchyLineChart = function(n){
                if(n.isSelected){
                    hierarchyAggregateExpressions.push(n._ae)
                }
                else{
                    const index = hierarchyAggregateExpressions.indexOf(n._ae);
                    hierarchyAggregateExpressions.splice(index, 1);
                }
                render();
            }

            var render = function(noAnimate){
                if(hierarchyAggregateExpressions.length){
                    authContext.getTsiToken().then(function(token){
                        tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', hierarchyAggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                            var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, hierarchyAggregateExpressions);
                            lineChartForHierarchy.render(transformedResult, {tooltip: true, grid: true, theme: "dark", noAnimate: noAnimate, legend: "compact"}, hierarchyAggregateExpressions);
                        });
                    })
                }
                else
                    lineChartForHierarchy.render([], {tooltip: true, grid: true, theme: "dark", legend: "compact"}, hierarchyAggregateExpressions);
            }
        }

        // 7. Line Chart With a Context Menu Which Generates Pie and Bar Chart
        var example7 = function() {
            renderChartContainers(3);

            var startDate = new Date('2017-04-12T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            var aggregateExpressions = [];
            var pieChart = new tsiClient.ux.PieChart(document.getElementById('chart2'));
            var barChart = new tsiClient.ux.BarChart(document.getElementById('chart3'));

            var barChartActions = [{
                name: "Print parameters to console",
                action: function(ae, splitBy, timestamp) {
                    console.log(ae);
                    console.log(splitBy);
                    console.log(timestamp);
                }
            }];

            var pieChartActions = [{
                name: "Copy to Bar Chart",
                action: function(ae, splitBy, timestamp) {
                    ae.contextMenu = barChartActions;
                    authContext.getTsiToken().then(function(token){
                        tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', [ae].map(function(ae){return ae.toTsx()})).then(function(result){
                            var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, [ae]); 
                            barChart.render(transformedResult, {grid: true, theme: 'light', timestamp: timestamp, arcWidthRatio: .6}, [ae]);
                        });
                    });
                }
            }]

            var contextMenuActions = [{
                name: "Print parameters to console",
                action: function(ae, splitBy, timestamp) {
                    console.log(ae);
                    console.log(splitBy);
                    console.log(timestamp);
                }
            }, 
            {
                name: "Plot as a Pie Chart",
                action: function(ae, splitBy, timestamp) {
                    ae.contextMenu = pieChartActions;
                    authContext.getTsiToken().then(function(token){
                        tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', [ae].map(function(ae){return ae.toTsx()})).then(function(result){
                            var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, [ae]); 
                            pieChart.render(transformedResult, {grid: true, theme: 'light', timestamp: timestamp, arcWidthRatio: .6}, [ae]);
                        });
                    });
                }
            }, {
                name: "Plot as a Bar Chart",
                action: function(ae, splitBy, timestamp) {
                    ae.contextMenu = barChartActions;
                    authContext.getTsiToken().then(function(token){
                        tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', [ae].map(function(ae){return ae.toTsx()})).then(function(result){
                            var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, [ae]); 
                            barChart.render(transformedResult, {grid: true, theme: 'light', timestamp: timestamp }, [ae]);
                        });
                    });
                }
            }];

            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, {color: '#F7727E', alias: 'Factory3Temperature', contextMenu: contextMenuActions}));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, {color: '#60B9AE', alias: 'Factory1Temperature', contextMenu: contextMenuActions}));
            
            var brushActions = [{
                name: "Print parameters to console",
                action: function(fromTime, toTime) {
                    console.log(fromTime);
                    console.log(toTime);
                }
            }];

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {theme: "light", legend: "compact", brushContextMenuActions: brushActions, grid: true, snapBrush: true, autoTriggerBrushContextMenu: true}, aggregateExpressions);
                });
            });
        }

        // 8. A Standalone Accessible Grid
        var example8 = function() {
            renderChartContainers(1);
            var aggregateExpressions = [];
            var startDate = new Date('2017-04-19T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '1m' }, {property: 'Station', type: 'String'}, '#F7727E', 'Factory3Temperature'));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: ""}, {property: 'Temperature', type: "Double"}, ['min', 'avg', 'max'],
                { from: startDate, to: endDate, bucketSize: '1m' }, {property: 'Id', type: 'String'}, '#C8E139', 'Factory1Temp'));
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var grid = new tsiClient.ux.Grid(document.getElementById('chart1'));
                    grid.renderFromAggregates(transformedResult, {}, [{color: '#F7727E'}, {color: '#C8E139'}]);
                });
            });
        }

        // 9. Heatmap
        var example9 = function() {
            renderChartContainers(1, [true]);
            var aggregateExpressions = [];
            var startDate = new Date('2017-04-15T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*5);
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3' and Temperature > 31"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '10m' }, {property: 'Station', type: 'String'}, '#008272', 'Factory3Temperature'));
            
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2'"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, '#FF8C00', 'Factory2Temperature'));

            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1' and Temperature < 0"}, {property: 'Temperature', type: "Double"}, ['avg', 'min'],
                { from: startDate, to: endDate, bucketSize: '2m' }, {property: 'Station', type: 'String'}, '#F7727E', 'Factory1Temperature'));

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var heatmap = new tsiClient.ux.Heatmap(document.getElementById('chart1'));
                    heatmap.render(transformedResult, {timestamp: '2017-04-15T13:00:00Z', theme: "dark"}, aggregateExpressions);
                });
            });
        }

        // 10. A Table of Events
        var example10 = function() {
            renderChartContainers(1);
            var startDate = new Date('2017-04-15T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*5);

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getEvents(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', {predicateString: "Factory = 'Factory1'"},  {}, startDate.valueOf(), endDate.valueOf()).then(function (events) {
                    var transformedEvents = tsiClient.ux.transformTsxToEventsArray(events, {});
                    var eventsTable = tsiClient.ux.EventsTable(document.getElementById('chart1'));
                    eventsTable.render(transformedEvents, {theme: 'light', offset: "Local"}, true);
                });
            });
        }

        // 11. An Availability Chart
        var example11 = function() {
            renderChartContainers(1);
            var brushActions = [{
                name: "Print From and to",
                action: function(fromTime, toTime) {
                    console.log(fromTime);
                    console.log(toTime);
                }
            }];

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAvailability(token, '10000000-0000-0000-0000-100000000109.env.timeseries.azure.com', '?api-version=2018-11-01-preview').then(function(result){
                    var transformedResult = tsiClient.ux.transformAvailabilityForVisualization(result.availability, 500);
                    document.getElementById("chart1").style.height = '200px';
                    var availabilityChart = new tsiClient.ux.AvailabilityChart(document.getElementById('chart1'));
                    availabilityChart.render(transformedResult, {theme: 'light', grid: false, tooltip: false, legend: "hidden", 
                        brushContextMenuActions: brushActions, snapBrush: false, maxBuckets: 500,
                        color: 'purple'}, result.availability);
                    
                    var chart = document.getElementById("chart1");
                    var button = document.createElement("button");
                    var isCompact = false;
                    function toggleCompact() {
                        isCompact = !isCompact;
                        availabilityChart.render(transformedResult, {theme: 'light', grid: false, tooltip: false, legend: "hidden", 
                                brushContextMenuActions: brushActions, snapBrush: false, maxBuckets: 500,
                                color: 'purple', isCompact: isCompact, preserveAvailabilityState: true}, result.availability);
                    }

                    button.id = "myButton";
                    button.textContent = "+/-";
                    button.addEventListener("click", toggleCompact, false);
                    button.style = 'position:absolute;top:0px'

                    chart.appendChild(button);
                });
            });
        }

        // 12. Line Chart With Min/Max Envelope and Step Interpolation 
        var example12 = function(){
            renderChartContainers(1, [true]);
            
            var aggregateExpressions = [];
            var startDate = new Date('2017-04-14T13:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*1);
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory1' and Pressure < .3"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, {color: '#FF8C00', alias: 'Factory1Pressure', interpolationFunction: 'curveStep'}));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory2' and Pressure < .3"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, {color: '#D869CB', alias: 'Factory2Pressure', includeEnvelope: true}));
            aggregateExpressions.push(new tsiClient.ux.AggregateExpression({predicateString: "Factory = 'Factory3' and Pressure < .3"}, {property: 'Pressure', type: "Double"}, ['avg', 'min', 'max'],
                { from: startDate, to: endDate, bucketSize: '2m' }, null, {color: '#60B9AE', alias: 'Factory.3.Pressure'}));
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getAggregates(token, '10000000-0000-0000-0000-100000000108.env.timeseries.azure.com', aggregateExpressions.map(function(ae){return ae.toTsx()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformAggregatesForVisualization(result, aggregateExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {theme: 'dark', grid: true, tooltip: true, legend: 'shown'}, aggregateExpressions);
                });
            });
        }

        // 13. Line Chart From PAYG SKU Environment 
        var example13 = function(){
            renderChartContainers(1, [true]);
            
            var tsqExpressions = [];
            var startDate = new Date('2017-04-20T20:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*24*30);
            
            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['df4412c4-dba2-4a52-87af-780e78ff156b']}, // instance json
                {Max: {
                    kind: 'numeric',
                    value: {tsx: '$event.value.Double'},
                    filter: null,
                    aggregation: {tsx: 'max($value)'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#60B9AE', // color
                'MaxValue')); // alias

            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['df4412c4-dba2-4a52-87af-780e78ff156b']}, // instance json
                {Avg: {
                    kind: 'numeric',
                    value: {tsx: '$event.value.Double'},
                    filter: null,
                    aggregation: {tsx: 'avg($value)'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#D869CB', // color
                'AvgValue')); // 
                
            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['df4412c4-dba2-4a52-87af-780e78ff156b']}, // instance json
                {Min: {
                    kind: 'numeric',
                    value: {tsx: '$event.value.Double'},
                    filter: null,
                    aggregation: {tsx: 'min($value)'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#FF8C00', // color
                'MinValue')); // alias

            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['df4412c4-dba2-4a52-87af-780e78ff156b']}, // instance json
                {Events: {
                    kind: 'aggregate',
                    value: null,
                    filter: null,
                    aggregation: {tsx: 'count()'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#8FE6D7', // color
                'EventCount')); // alias

            authContext.getTsiToken().then(function(token){
                tsiClient.server.getTsqResults(token, '10000000-0000-0000-0000-100000000109.env.timeseries.azure.com', tsqExpressions.map(function(ae){return ae.toTsq()})).then(function(result){
                    var transformedResult = tsiClient.ux.transformTsqResultsForVisualization(result, tsqExpressions);
                    var lineChart = new tsiClient.ux.LineChart(document.getElementById('chart1'));
                    lineChart.render(transformedResult, {theme: 'dark', grid: true, tooltip: true, legend: 'compact'}, tsqExpressions);
                });
            });
        }


        // 14. Model Search Component With Hierarchy
        var example14 = function() {
            renderChartContainers(1);
            document.getElementById("chart1").style.width = '400px';
            var hierarchy = {
                'Factory1': {
                    'Station1A': {
                        'Station1': {
                            'GC4F-286 (Temp)': {$leaf: true, click: function(n){
                                console.log(n);
                            }},
                            'F92-21B (Pressure)': {$leaf: true, click: function(n){
                                console.log(n);
                            }}                    
                        }
                    }
                },
                'Factory2': {
                    'Station1': {
                        '19C2-F8 (Temp)': {$leaf: true, click: function(n){
                            console.log(n);
                        }},
                        'B9-C86 (Pressure)': {$leaf: true, click: function(n){
                            console.log(n);
                        }},         
                        '~19C2-F8 (Temp)': {$leaf: true, click: function(n){
                            console.log(n);
                        }},
                        '~B9-C86 (Pressure)': {$leaf: true, click: function(n){
                            console.log(n);
                        }}           
                    }
                }
            }

            var onInstanceClick = function(instance) {
                let contextMenuActions = [];
                Object.keys(instance.type.variables).forEach(function(vName){
                    contextMenuActions['Show ' + vName] = function(){console.log(instance.type.variables[vName])}
                });
                contextMenuActions.push({});
                contextMenuActions[0]['Show some other var'] = function(){console.log('var2')}
                contextMenuActions[0]['Show another var'] = function(){console.log('var3')}
                contextMenuActions.push({});
                contextMenuActions[1]['Show some other var2'] = function(){console.log('var2')}
                contextMenuActions[1]['Show another var2'] = function(){console.log('var3')}
                return contextMenuActions;
            }

            var modelSearch = new tsiClient.ux.ModelSearch(document.getElementById('chart1'));	            
            modelSearch.render('10000000-0000-0000-0000-100000000109.env.timeseries.azure.com', authContext.getTsiToken, hierarchy, {theme: 'light', onInstanceClick: onInstanceClick});
        }

        // 15. A Standalone Model Autocomplete Component
        var example15 = function() {
            renderChartContainers(1);
            var modelAutocomplete = new tsiClient.ux.ModelAutocomplete(document.getElementById('chart1'));	            
            var onInput = function(searchText){console.log(searchText)};
            var onKeydown = function(d3Event, awesompleteObject){console.log(d3Event); console.log(awesompleteObject)};
            modelAutocomplete.render('10000000-0000-0000-0000-100000000109.env.timeseries.azure.com', authContext.getTsiToken, {onInput: onInput, onKeydown: onKeydown});
        }

        // 16. A Table of Events from a PAYG SKU
        var example16 = function() {
            renderChartContainers(1);
            var tsqExpressions = [];
            var startDate = new Date('2017-04-15T00:00:00Z');
            var endDate = new Date(startDate.valueOf() + 1000*60*60*24*2);

            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['f39ef799-eaa3-4019-81ef-a939b6921728']}, // instance json
                {AvgValue: {
                    kind: 'numeric',
                    value: {tsx: '$event.value.Double'},
                    filter: null,
                    aggregation: {tsx: 'max($value)'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#60B9AE', // color
                'MaxValue')); // alias

            tsqExpressions.push(new tsiClient.ux.TsqExpression(
                {timeSeriesId: ['df4412c4-dba2-4a52-87af-780e78ff156b']}, // instance json
                {AvgValue: {
                    kind: 'numeric',
                    value: {tsx: '$event.value.Double'},
                    filter: null,
                    aggregation: {tsx: 'avg($value)'}
                }}, // variable json
                { from: startDate, to: endDate, bucketSize: '6h' }, // search span
                '#D869CB', // color
                'MaxValue')); // alias
            
            authContext.getTsiToken().then(function(token){
                tsiClient.server.getTsqResults(token, '10000000-0000-0000-0000-100000000109.env.timeseries.azure.com', tsqExpressions.map(function(ae){return ae.toTsq(true, true)})).then(function(result){
                    var transformedEvents = tsiClient.ux.transformTsqResultsToEventsArray(result);
                    var eventsTable = tsiClient.ux.EventsTable(document.getElementById('chart1'));
                    eventsTable.render(transformedEvents, {theme: 'light'}, true);
                });
            });
        }

        // Initial load, supports linking to a specific example by hash
        if(!window.location.hash)
            example1();
        else {
            let exampleNumber = window.location.hash.split('#')[1];
            document.getElementById('selectTitle').value = exampleNumber;
            window['example' + exampleNumber]();
        }

    </script>
</body>
</html>